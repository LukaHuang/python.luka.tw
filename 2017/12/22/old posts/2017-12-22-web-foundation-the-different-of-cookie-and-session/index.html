<!DOCTYPE html><html class="appearance-light" lang="en"><head><meta charset="UTF-8"><title>Web 基本功 - Cookie 與 Session</title><meta name="description"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/widget-post-list.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="Cookie1.1 什麼是 Cookie ?Cookie 在使用者第一次進入網站的時候產生。Browser 記錄一些隱私性較低的資料。例如: 使用者第一次進入網站的時候會跳出教學視窗。當使用者點擊[關閉]後，Cookie內記錄使用者已經看過教學了。使用者在下次登入的時候因為 Cookie 內記錄著使用者已經看過教學，所以就不會跳出教學視窗。
1.2 Cookie 的特性
每個網站的 Cookie 是分開的, 例如: www.google.com 無法取得 www.yahoo.com 的 cookie。
能夠設定失效的時間。比如說過一段時間你就需要重新登入，就是由設定 Cookie Expired Time 來完成。有時候為了方便，也可能將 Cookie 設定為永久不失效。

1.3 Server 端如何讓 .."><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Luka.tw</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Web 基本功 - Cookie 與 Session</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><div class="post-container" style="position: sticky; top: 50px;"><main class="aside-card-container categories-widget category-page"><h3 style="font-size:1em;">Categories</h3><section><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/01-Python-%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/">01 Python 基礎教學</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/02-Python-%E7%88%AC%E8%9F%B2%E6%95%99%E5%AD%B8/">02 Python 爬蟲教學</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/03-Python-Flask-%E6%95%99%E5%AD%B8/">03 Python Flask 教學</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/04-Python-Django-%E6%95%99%E5%AD%B8/">04 Python Django 教學</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/05-Python-%E8%B3%87%E6%96%99%E5%BA%AB%E6%95%99%E5%AD%B8/">05 Python 資料庫教學</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/06-Python-%E8%B3%87%E6%96%99%E5%88%86%E6%9E%90/">06 Python 資料分析</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/07-Python-%E6%A9%9F%E5%99%A8%E5%AD%B8%E7%BF%92/">07 Python 機器學習</a><span class="category-list-count">1</span></li></ul></section></main><div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookie"><span class="toc-text">Cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E9%BA%BC%E6%98%AF-Cookie"><span class="toc-text">1.1 什麼是 Cookie ?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Cookie-%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-text">1.2 Cookie 的特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Server-%E7%AB%AF%E5%A6%82%E4%BD%95%E8%AE%93-Browser-%E5%84%B2%E5%AD%98-Cookie"><span class="toc-text">1.3 Server 端如何讓 Browser 儲存 Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Browser-%E5%9C%A8%E6%AF%8F%E6%AC%A1-Request-%E7%9A%84%E6%99%82%E5%80%99%E6%9C%83%E5%B8%B6%E4%B8%8A-Cookie"><span class="toc-text">1.4 Browser 在每次 Request 的時候會帶上 Cookie</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session"><span class="toc-text">Session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%BB%80%E9%BA%BC%E6%98%AF-Session"><span class="toc-text">2.1 什麼是 Session</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Cookie-based-Session-%E8%88%87-Session-Storage"><span class="toc-text">2.2 Cookie-based Session 與 Session Storage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%AF%94%E8%BC%83-Cookie-based-Session-%E8%88%87-Memcached-Store-Session"><span class="toc-text">2.3 比較 Cookie-based Session 與 Memcached Store Session</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Session-%E5%82%B3%E5%80%BC"><span class="toc-text">2.4 Session 傳值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rails-%E4%B8%AD%E7%9A%84-Cookie-based-Session-%E5%AE%89%E5%85%A8%E6%80%A7%E5%95%8F%E9%A1%8C"><span class="toc-text">Rails 中的 Cookie-based Session 安全性問題</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#references"><span class="toc-text">references</span></a></li></ol></div></div></div><div class="column is-9"><header class="my-4"><a href="/tags/Web-Foundation"><i class="tag post-item-tag">Web Foundation</i></a><a href="/tags/Coockie"><i class="tag post-item-tag">Coockie</i></a><a href="/tags/Session"><i class="tag post-item-tag">Session</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Web 基本功 - Cookie 與 Session</h1><time class="has-text-grey" datetime="2017-12-22T06:11:00.000Z">2017-12-22</time><article class="mt-2 post-content"><h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><h3 id="1-1-什麼是-Cookie"><a href="#1-1-什麼是-Cookie" class="headerlink" title="1.1 什麼是 Cookie ?"></a>1.1 什麼是 Cookie ?</h3><p>Cookie 在使用者第一次進入網站的時候產生。Browser 記錄一些隱私性較低的資料。<br>例如: 使用者第一次進入網站的時候會跳出教學視窗。當使用者點擊[關閉]後，Cookie<br>內記錄使用者已經看過教學了。使用者在下次登入的時候因為 Cookie 內記錄著使用者<br>已經看過教學，所以就不會跳出教學視窗。</p>
<h3 id="1-2-Cookie-的特性"><a href="#1-2-Cookie-的特性" class="headerlink" title="1.2 Cookie 的特性"></a>1.2 Cookie 的特性</h3><ul>
<li>每個網站的 Cookie 是分開的, 例如: <a target="_blank" rel="noopener" href="http://www.google.com/">www.google.com</a> 無法取得 <a target="_blank" rel="noopener" href="http://www.yahoo.com/">www.yahoo.com</a> 的 cookie。</li>
<li>能夠設定失效的時間。比如說過一段時間你就需要重新登入，就是由設定 Cookie Expired Time 來完成。有時候為了方便，也可能將 Cookie 設定為永久不失效。</li>
</ul>
<h3 id="1-3-Server-端如何讓-Browser-儲存-Cookie"><a href="#1-3-Server-端如何讓-Browser-儲存-Cookie" class="headerlink" title="1.3 Server 端如何讓 Browser 儲存 Cookie"></a>1.3 Server 端如何讓 Browser 儲存 Cookie</h3><ol>
<li>Client 請求 Server 給予頁面</li>
<li>Server 回 Response 給 Browser 的時候，HTTP Header 帶上 <code>Set-Cookie</code>。Browser 接收到 Set-Cookie 指令時，會將 Cookie 的名稱和值儲存在 Browser 的 Cookie。</li>
</ol>
<p><img src="https://lh3.googleusercontent.com/-ivTQRwbrQzs/WjyiAfiRepI/AAAAAAAAK7Y/8pjRBORXGEIKxyP7bjFTiEHjPYroooXQwCHMYCw/I/15139142578413.jpg"></p>
<h3 id="1-4-Browser-在每次-Request-的時候會帶上-Cookie"><a href="#1-4-Browser-在每次-Request-的時候會帶上-Cookie" class="headerlink" title="1.4 Browser 在每次 Request 的時候會帶上 Cookie"></a>1.4 Browser 在每次 Request 的時候會帶上 Cookie</h3><p>Browser 在每次對 Server 發出 Request 的時候會帶上 <code>Cookie</code> 的 Header，讓 Server 能夠正確的存取當前 Cookie。</p>
<p><img src="https://lh3.googleusercontent.com/-316qWgn_JFg/WjyiAwnYu4I/AAAAAAAAK7c/jUqct0G-OeIYDDq5DxyM_rR1azOAClRnwCHMYCw/I/15139133853587.jpg"></p>
<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><h3 id="2-1-什麼是-Session"><a href="#2-1-什麼是-Session" class="headerlink" title="2.1 什麼是 Session"></a>2.1 什麼是 Session</h3><p>Session 就像你進入一個遊樂園，手上先蓋個章，下次進入的時候就知道你是誰。<br>遊樂園就好比是 Server，你就好比是 Client (Browser)。<br>Client 要怎麼儲存這個章呢? 有兩種方法:</p>
<ol>
<li>使用 Cookie (set cookie)</li>
<li>使用 html 儲存，例如: hidden input。</li>
</ol>
<p>拿章去 Server 換資料也有兩種方法:</p>
<ol>
<li>使用 Cookie</li>
<li>Query string/POST</li>
</ol>
<p>因為實作上的方便程度與效能考量，大部分的網站採用 Cookie 來完成 Session 的實作。</p>
<h3 id="2-2-Cookie-based-Session-與-Session-Storage"><a href="#2-2-Cookie-based-Session-與-Session-Storage" class="headerlink" title="2.2 Cookie-based Session 與 Session Storage"></a>2.2 Cookie-based Session 與 Session Storage</h3><p>Cookie-based Session 指的 Session 儲存的方式不同，而不是拿章去 Server 換資料的時候有沒有使用 Cookie。</p>
<p>常見的 Session Storage 有這幾種:</p>
<ol>
<li>Database</li>
<li>Memcached</li>
<li>Cookie</li>
</ol>
<h3 id="2-3-比較-Cookie-based-Session-與-Memcached-Store-Session"><a href="#2-3-比較-Cookie-based-Session-與-Memcached-Store-Session" class="headerlink" title="2.3 比較 Cookie-based Session 與 Memcached Store Session"></a>2.3 比較 Cookie-based Session 與 Memcached Store Session</h3><p>來比較一下這兩者的優缺點。 Cookie-based Session 的優點:</p>
<ul>
<li>對伺服器的效能負擔很低</li>
<li>方便使用</li>
</ul>
<p>缺點:</p>
<ul>
<li>大小最多存4Kb。</li>
<li>資料存放在瀏覽器上如果 <code>config/secrets.yml</code> 外流可能存在被破解的風險 (詳見 <a target="_blank" rel="noopener" href="http://tech.shaolin.tw/posts/2013/12/17/security-issue-of-rails-cookiestore-mechanism/">Rails CookieStore 的安全議題</a>)。</li>
</ul>
<p>Memcached Store Session 的優點:</p>
<ol>
<li>memcached 使用記憶體來儲存，讀取速度快。</li>
<li>可以實現集中式管理。</li>
<li>不會受到 cookie 4kb 大小的限制。</li>
</ol>
<p>缺點：</p>
<ol>
<li>儲存方式用記憶體，持久化有疑慮。</li>
<li>在追求高性能高併發的情景下，cookies 的表現更好，因此很多大網站採用 cookies 作為 session store.</li>
</ol>
<h3 id="2-4-Session-傳值"><a href="#2-4-Session-傳值" class="headerlink" title="2.4 Session 傳值"></a>2.4 Session 傳值</h3><p>Session 傳值指的是利用 Session 儲存資料的機制，讓不同頁面間可以互相傳遞資料。</p>
<ol>
<li>使用 Query String 或是 POST 把資料往 Server 傳</li>
<li>Server 將收到的資料存到 Session 中。</li>
<li>在不同頁面的時候因為你的章是同一個，可以讀取 Session 中儲存的資料也是同一份，達到傳值的目的。</li>
</ol>
<h2 id="Rails-中的-Cookie-based-Session-安全性問題"><a href="#Rails-中的-Cookie-based-Session-安全性問題" class="headerlink" title="Rails 中的 Cookie-based Session 安全性問題"></a>Rails 中的 Cookie-based Session 安全性問題</h2><p>Rails 3 以前 cookie-based session 如果不特別設定，可以輕易的被解開:</p>
<pre><code class="rb">require &#39;base64&#39;
session_cookie = &#39;your session cookie&#39;
Marshal.load(Base64.decode64(sesson_cookie.split(&#39;--&#39;).first))
</code></pre>
<p>解開後會像這個樣子</p>
<pre><code class="rb">&#123;
        &quot;session_id&quot; =&gt; &quot;3223668cb4b04296c006e190ce2b1a17&quot;,
    &quot;user_return_to&quot; =&gt; &quot;/&quot;,
             &quot;flash&quot; =&gt; #&lt;ActionDispatch::Flash::FlashHash:0x007f80d1090250 @used=#&lt;Set: &#123;:alert&#125;&gt;, @closed=false, @flashes=&#123;:alert=&gt;&quot;You need to sign in or sign up before continuing.&quot;, :warning=&gt;nil, :error=&gt;nil, :notice=&gt;nil&#125;, @now=nil&gt;,
       &quot;_csrf_token&quot; =&gt; &quot;BxX8rLulhq2v2YSKrLxIIkYeV4IYNTNceT2ib1BrO08=&quot;
&#125;
</code></pre>
<p>Rails 4 以後的 Cookie-based Session 會經過 Secret 加密。好好保護你的 <code>config/secret.yml</code> 能夠讓 Session 中的隱密資料不會被解開，從下面 code 可以看出要解開的話需要不少的麻煩:</p>
<pre><code class="rb">require &#39;rubygems&#39;
require &#39;cgi&#39;
require &#39;active_support&#39;

def decrypt_session_cookie(cookie, key)
  cookie = CGI::unescape(cookie)

  # Default values for Rails 4 apps
  key_iter_num = 1000
  key_size     = 64
  salt         = &quot;encrypted cookie&quot;
  signed_salt  = &quot;signed encrypted cookie&quot;

  key_generator = ActiveSupport::KeyGenerator.new(key, iterations: key_iter_num)
  secret = key_generator.generate_key(salt)
  sign_secret = key_generator.generate_key(signed_salt)

  encryptor = ActiveSupport::MessageEncryptor.new(secret, sign_secret)
  puts encryptor.decrypt_and_verify(cookie)
end


# Time to test ... (With data from Arbeit327)
cookie = &#39;WVFQVTFtbmNxWWJPODZNb3NUMVZzZGtDVjZQNXpMYStFMWdiZlJPMkdjRFRBOGZ5T3pOTzBPKzk3NWxvQUJvTlRRU2t4MXZmdG8rT0I0R2M3Ulh0YXpxRVhNMll5UW1xUHhvVXBLbXozZ3ZyNjB4VDU4dWRIUkxBWjBXbDJhci93YkYrZWswUHdFL0hUNDJaUHo2cEpxbXFvdlFZMjJWVU9KTWhHb3NyalFwTkphd0pUQVZSTXRHbkVqRlFnSGpNVTNFQlVxYlRmT3pWbXNjK0JuQ3FydzQvODRhbmtuU29haGNRbXQ4T3o1ZjhqMk53WTRMa0pVd1hPb2NHTVFQY3dvanE2ZElqUk1Mc21HS0k2SHVuZEZ3OWhjdzZPQnRSMEdVVkQwL2IxSVh5QzNSWVlJZms5c1JJV0lzUE1Zb1NHbEtqYm5nTGRKd1ZSdGpOQ1RZZWthR1A2anRFMEluaTcyWTNaNHJBR1N0dklzMkg1RjVmVmY4azEzV3o0N2Z2LS1wQlowRUZ6cjI3SVFQU0F5bGlYSDNnPT0%3D--19650cc5c3e2599fb43b7235ab4de5a1ce8a46ac&#39;
key = &#39;aeb977de013ade650b97e0aa5246813591104017871a7753fe186e9634c9129b367306606878985c759ca4fddd17d955207011bb855ef01ed414398b4ac8317b&#39;

decrypt_session_cookie(cookie, key)
</code></pre>
<h2 id="references"><a href="#references" class="headerlink" title="references"></a>references</h2><p><a target="_blank" rel="noopener" href="http://blog.hellojcc.tw/2016/01/12/introduce-session-and-cookie/">介紹 Session 及 Cookie 兩者的差別說明</a></p>
<p><a target="_blank" rel="noopener" href="http://fred-zone.blogspot.tw/2014/01/web-session.html">FRED - Web 技術中的 Session 是什麼？</a></p>
<p><a target="_blank" rel="noopener" href="http://tech.shaolin.tw/posts/2013/12/17/security-issue-of-rails-cookiestore-mechanism/">Rails CookieStore 的安全議題 - Shaolin.TW</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.miniasp.com/post/2008/02/22/Explain-HTTP-Cookie-in-Detail.aspx">The Will Will Web - 解釋 Cookie 的特性</a></p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/profh/e36e5dd0bec124fef04c">A simple script to decode Rails 4 session cookies</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2018/01/03/old%20posts/2018-01-03-aws-s3-delimiter-and-prefix/" title="[譯] Amazon S3 Delimiter and Prefix"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: [譯] Amazon S3 Delimiter and Prefix</span></a><a class="button is-default" href="/2017/12/22/old%20posts/2017-12-29-oltp-vs-olap/" title="OLTP 與 OLAP"><span class="has-text-weight-semibold">Next: OLTP 與 OLAP</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="LukaHuang/" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/LukaHuang"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><a title="linkedin" target="_blank" rel="noopener nofollow" href="//www.linkedin.com/in/LukaHuang"><i class="iconfont icon-linkedin"></i></a><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//CodeShiba"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Luka.tw 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo </p></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>